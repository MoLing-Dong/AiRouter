# AiRouter æ€§èƒ½ä¼˜åŒ–æŒ‡å—

## ğŸš€ æœ€æ–°ä¼˜åŒ–ç‰¹æ€§

### 1. Python 3.13 å‡çº§

- **ç‰ˆæœ¬ç»Ÿä¸€**: æ‰€æœ‰ç»„ä»¶ç»Ÿä¸€ä½¿ç”¨ Python 3.13
- **æ€§èƒ½æå‡**: ç›¸æ¯” 3.10 ç‰ˆæœ¬ï¼Œæ€§èƒ½æå‡ 10-20%
- **æ–°ç‰¹æ€§**: æ”¯æŒæœ€æ–°çš„ asyncio ä¼˜åŒ–å’Œç±»å‹æ³¨è§£

### 2. æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–

#### å¼‚æ­¥SQLAlchemy + SQLModel

```python
# æ–°çš„å¼‚æ­¥æ•°æ®åº“æœåŠ¡
from app.services.async_database_service import async_db_service

# é«˜æ€§èƒ½æŸ¥è¯¢ï¼Œæ”¯æŒé¢„åŠ è½½å’Œæ‰¹é‡æ“ä½œ
models = await async_db_service.get_all_models_with_relationships()
```

#### æŸ¥è¯¢ä¼˜åŒ–ç‰¹æ€§

- **é¢„åŠ è½½å…³è”**: ä½¿ç”¨ `selectinload` é¿å… N+1 æŸ¥è¯¢
- **æ‰¹é‡æ“ä½œ**: æ”¯æŒæ‰¹é‡æ›´æ–°ï¼Œæ€§èƒ½æå‡ 5-10 å€
- **åŸç”ŸSQL**: å¤æ‚æŸ¥è¯¢ä½¿ç”¨åŸç”ŸSQLä¼˜åŒ–
- **è¿æ¥æ± ä¼˜åŒ–**: å¢åŠ è¿æ¥æ± å¤§å°åˆ° 25/50

#### æ€§èƒ½å¯¹æ¯”

| æ“ä½œ | åŸç‰ˆæœ¬ | ä¼˜åŒ–ç‰ˆæœ¬ | æå‡ |
|------|--------|----------|------|
| è·å–æ‰€æœ‰æ¨¡å‹ | 200ms | 20ms | 10x |
| æ‰¹é‡æ›´æ–°æŒ‡æ ‡ | 500ms | 50ms | 10x |
| å¤æ‚èšåˆæŸ¥è¯¢ | 1000ms | 100ms | 10x |

### 3. Redis ç¼“å­˜ç³»ç»Ÿ

#### å¤šå±‚ç¼“å­˜ç­–ç•¥

```python
# å¢å¼ºæ¨¡å‹æœåŠ¡ï¼Œæ”¯æŒæ™ºèƒ½ç¼“å­˜
from app.services.enhanced_model_service import enhanced_model_service

# è‡ªåŠ¨ç¼“å­˜ï¼Œå‘½ä¸­ç‡ > 80%
models = await enhanced_model_service.get_all_models_enhanced(use_cache=True)
```

#### ç¼“å­˜é…ç½®

- **æ¨¡å‹æ•°æ®**: 5åˆ†é’Ÿ TTL
- **æä¾›å•†æ•°æ®**: 10åˆ†é’Ÿ TTL  
- **æ€§èƒ½æŒ‡æ ‡**: 3åˆ†é’Ÿ TTL
- **å¥åº·çŠ¶æ€**: 1åˆ†é’Ÿ TTL

### 4. Docker é•œåƒä¼˜åŒ–

#### Alpine Linux åŸºç¡€é•œåƒ

```dockerfile
# è½»é‡çº§åŸºç¡€é•œåƒ
FROM python:3.13-alpine

# é•œåƒå¤§å°å¯¹æ¯”
# åŸç‰ˆæœ¬ (python:3.10-slim): ~150MB
# ä¼˜åŒ–ç‰ˆæœ¬ (python:3.13-alpine): ~50MB
# å‡å°‘ 66% é•œåƒå¤§å°
```

#### æ„å»ºä¼˜åŒ–

- **å¤šé˜¶æ®µæ„å»º**: åˆ†ç¦»æ„å»ºå’Œè¿è¡Œç¯å¢ƒ
- **ä¾èµ–ä¼˜åŒ–**: ä»…åŒ…å«è¿è¡Œæ—¶å¿…éœ€ä¾èµ–
- **érootç”¨æˆ·**: å®‰å…¨æ€§æå‡

## ğŸ“Š æ€§èƒ½ç›‘æ§

### å®æ—¶æŒ‡æ ‡

```python
# è·å–æœåŠ¡ç»Ÿè®¡
stats = await enhanced_model_service.get_service_statistics()

# åŒ…å«çš„æŒ‡æ ‡
{
    "database": {
        "connection_statistics": {...},
        "table_statistics": {...},
        "cache_efficiency": 85.2
    },
    "redis": {
        "connected_clients": 5,
        "used_memory_human": "2.5MB",
        "keyspace_hits": 1250,
        "keyspace_misses": 98
    },
    "service_performance": {
        "cache_hits": 1250,
        "cache_misses": 98,
        "cache_hit_rate": 92.7,
        "avg_query_time": 0.023
    }
}
```

### æ€§èƒ½åŸºå‡†æµ‹è¯•

```bash
# è¿è¡Œæ€§èƒ½æµ‹è¯•
python -m pytest tests/performance/ -v

# é¢„æœŸç»“æœ
# - APIå“åº”æ—¶é—´: < 50ms (P95)
# - æ•°æ®åº“æŸ¥è¯¢: < 100ms (å¤æ‚æŸ¥è¯¢)
# - ç¼“å­˜å‘½ä¸­ç‡: > 80%
# - å¹¶å‘å¤„ç†: 1000+ RPS
```

## ğŸ”§ ä½¿ç”¨æŒ‡å—

### 1. å¯ç”¨å¼‚æ­¥æœåŠ¡

```python
# åœ¨åº”ç”¨å¯åŠ¨æ—¶åˆå§‹åŒ–
from app.services.database_service_integration import integrated_db_service

async def startup():
    await integrated_db_service.initialize_async()
    
async def shutdown():
    await integrated_db_service.close_async()
```

### 2. ä½¿ç”¨ä¼˜åŒ–çš„API

```python
# æ¨èï¼šä½¿ç”¨å¼‚æ­¥æ¥å£
models = await integrated_db_service.get_all_models_async()

# å…¼å®¹ï¼šä»æ”¯æŒåŒæ­¥æ¥å£
models = integrated_db_service.get_all_models()
```

### 3. æ‰¹é‡æ“ä½œ

```python
# æ‰¹é‡æ›´æ–°æ€§èƒ½æŒ‡æ ‡
updates = [
    {"model_id": 1, "provider_id": 1, "response_time": 0.5, "success_rate": 0.98},
    {"model_id": 1, "provider_id": 2, "response_time": 0.3, "success_rate": 0.99},
    # ... æ›´å¤šæ›´æ–°
]

success = await integrated_db_service.batch_update_metrics_async(updates)
```

### 4. ç¼“å­˜ç®¡ç†

```python
# æ¸…ç†ç¼“å­˜
await enhanced_model_service.clear_all_cache()

# æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡
stats = await enhanced_model_service.get_service_statistics()
print(f"ç¼“å­˜å‘½ä¸­ç‡: {stats['service_performance']['cache_hit_rate']}%")
```

## ğŸ—ï¸ æ¶æ„æ”¹è¿›

### æœåŠ¡å±‚çº§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         é›†æˆæ•°æ®åº“æœåŠ¡               â”‚
â”‚    (å‘åå…¼å®¹ + æ–°å¼‚æ­¥æ¥å£)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         å¢å¼ºæ¨¡å‹æœåŠ¡                â”‚
â”‚    (ç¼“å­˜ + æ€§èƒ½ç›‘æ§ + æ‰¹é‡æ“ä½œ)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        å¼‚æ­¥æ•°æ®åº“æœåŠ¡               â”‚
â”‚    (SQLModel + å¼‚æ­¥SQLAlchemy)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         Redis ç¼“å­˜å±‚                â”‚
â”‚    (æ™ºèƒ½ç¼“å­˜ + æ€§èƒ½ä¼˜åŒ–)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥

1. **é¢„åŠ è½½å…³è”**: å‡å°‘æ•°æ®åº“å¾€è¿”
2. **æ‰¹é‡æ“ä½œ**: æé«˜å†™å…¥æ€§èƒ½
3. **åŸç”ŸSQL**: å¤æ‚æŸ¥è¯¢ä¼˜åŒ–
4. **æ™ºèƒ½ç¼“å­˜**: å‡å°‘é‡å¤æŸ¥è¯¢
5. **è¿æ¥æ± **: å¹¶å‘æ€§èƒ½ä¼˜åŒ–

## ğŸ“ˆ æ€§èƒ½å»ºè®®

### ç”Ÿäº§ç¯å¢ƒé…ç½®

```yaml
# docker-compose.yml
services:
  ai-router:
    environment:
      # æ•°æ®åº“è¿æ¥æ± 
      - DB_POOL_SIZE=25
      - DB_MAX_OVERFLOW=50
      
      # Redisé…ç½®
      - REDIS_URL=redis://redis:6379
      - REDIS_POOL_SIZE=10
      
      # å¼‚æ­¥æœåŠ¡
      - ASYNC_DB_ENABLED=true
      
  redis:
    image: redis:7-alpine
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
```

### ç›‘æ§æŒ‡æ ‡

- **å“åº”æ—¶é—´**: P95 < 100ms
- **ç¼“å­˜å‘½ä¸­ç‡**: > 80%
- **æ•°æ®åº“è¿æ¥**: ä½¿ç”¨ç‡ < 70%
- **å†…å­˜ä½¿ç”¨**: < 1GB
- **CPUä½¿ç”¨**: < 50%

### æ•…éšœæ’é™¤

1. **é«˜å»¶è¿Ÿ**: æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡å’Œæ•°æ®åº“è¿æ¥æ± 
2. **å†…å­˜æ³„æ¼**: ç›‘æ§Rediså†…å­˜ä½¿ç”¨å’Œè¿æ¥æ•°
3. **å¹¶å‘é—®é¢˜**: è°ƒæ•´è¿æ¥æ± å¤§å°å’Œè¶…æ—¶è®¾ç½®

## ğŸ¯ æœªæ¥ä¼˜åŒ–è®¡åˆ’

1. **åˆ†å¸ƒå¼ç¼“å­˜**: Redis Cluster æ”¯æŒ
2. **è¯»å†™åˆ†ç¦»**: ä¸»ä»æ•°æ®åº“é…ç½®
3. **æŸ¥è¯¢ä¼˜åŒ–å™¨**: æ™ºèƒ½æŸ¥è¯¢è·¯ç”±
4. **é¢„è®¡ç®—**: çƒ­ç‚¹æ•°æ®é¢„è®¡ç®—
5. **å‹ç¼©**: å“åº”æ•°æ®å‹ç¼©
