# Services æ¶æ„æ–‡æ¡£

## ğŸ“ ç›®å½•ç»“æ„ï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰

```
app/services/
â”œâ”€â”€ __init__.py                      # ç»Ÿä¸€æœåŠ¡å¯¼å‡ºå…¥å£
â”‚
â”œâ”€â”€ model/                           # ğŸ”µ æ¨¡å‹é¢†åŸŸ
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ model_service.py             # æ¨¡å‹æ ¸å¿ƒç®¡ç†æœåŠ¡ï¼ˆCRUDï¼‰
â”‚   â”œâ”€â”€ model_query_service.py       # æ¨¡å‹æŸ¥è¯¢æœåŠ¡ï¼ˆç”¨äºAPIå±•ç¤ºï¼‰
â”‚   â”œâ”€â”€ cache_manager.py             # æ¨¡å‹åˆ—è¡¨ç¼“å­˜ç®¡ç†
â”‚   â””â”€â”€ model_provider_service.py    # æ¨¡å‹-æä¾›å•†å…³è”æœåŠ¡
â”‚
â”œâ”€â”€ capability/                      # ğŸŸ¢ èƒ½åŠ›é¢†åŸŸ
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ capability_service.py        # èƒ½åŠ›ç®¡ç†æœåŠ¡
â”‚
â”œâ”€â”€ provider/                        # ğŸŸ  æä¾›å•†é¢†åŸŸ
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ provider_service.py          # æä¾›å•†ç®¡ç†æœåŠ¡
â”‚
â”œâ”€â”€ database/                        # ğŸ”´ æ•°æ®è®¿é—®æœåŠ¡å±‚
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ database_service.py          # åŒæ­¥æ•°æ®åº“æœåŠ¡
â”‚   â”œâ”€â”€ async_database_service.py   # å¼‚æ­¥æ•°æ®åº“æœåŠ¡
â”‚   â”œâ”€â”€ sqlmodel_database_service.py # SQLModel æ•°æ®åº“æœåŠ¡
â”‚   â””â”€â”€ transaction_manager.py       # äº‹åŠ¡ç®¡ç†å™¨
â”‚
â”œâ”€â”€ adapters/                        # ğŸŸ¤ é€‚é…å™¨ç®¡ç†æœåŠ¡
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ adapter_manager.py           # é€‚é…å™¨ç®¡ç†å™¨
â”‚   â”œâ”€â”€ adapter_factory.py           # é€‚é…å™¨å·¥å‚
â”‚   â”œâ”€â”€ adapter_pool.py              # é€‚é…å™¨æ± 
â”‚   â””â”€â”€ adapter_health_checker.py    # é€‚é…å™¨å¥åº·æ£€æŸ¥
â”‚
â”œâ”€â”€ load_balancing/                  # ğŸŸ¡ è´Ÿè½½å‡è¡¡æœåŠ¡
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ router.py                    # æ™ºèƒ½è·¯ç”±å™¨
â”‚   â””â”€â”€ load_balancing_strategies.py # è´Ÿè½½å‡è¡¡ç­–ç•¥
â”‚
â”œâ”€â”€ monitoring/                      # ğŸŸ£ ç›‘æ§æœåŠ¡
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ health_check_service.py      # å¥åº·æ£€æŸ¥æœåŠ¡
â”‚
â””â”€â”€ infrastructure/                  # âš™ï¸ åŸºç¡€è®¾æ–½æœåŠ¡
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ service_factory.py           # æœåŠ¡å·¥å‚ï¼ˆä¾èµ–æ³¨å…¥ï¼‰
    â””â”€â”€ service_manager.py           # æœåŠ¡ç®¡ç†å™¨ï¼ˆæœåŠ¡åè°ƒï¼‰
```

## ğŸ—ï¸ æ¶æ„è®¾è®¡ç†å¿µ

### é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰

æœ¬é¡¹ç›®é‡‡ç”¨**é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDomain-Driven Designï¼‰**çš„å‚ç›´åˆ‡åˆ†æ–¹å¼ï¼Œè€Œéä¼ ç»Ÿçš„ MVC æ°´å¹³åˆ‡åˆ†ã€‚

#### ä¸ºä»€ä¹ˆé€‰æ‹© DDDï¼Ÿ

1. **ä¸šåŠ¡èšåˆ** - åŒä¸€ä¸šåŠ¡é¢†åŸŸçš„ä»£ç èšåˆåœ¨ä¸€èµ·ï¼Œä¾¿äºç†è§£å’Œç»´æŠ¤
2. **é«˜å†…èšä½è€¦åˆ** - é¢†åŸŸå†…éƒ¨é«˜å†…èšï¼Œé¢†åŸŸä¹‹é—´ä½è€¦åˆ
3. **å›¢é˜Ÿåä½œ** - ä¸åŒå›¢é˜Ÿå¯ä»¥ç‹¬ç«‹è´Ÿè´£ä¸åŒé¢†åŸŸ
4. **ä¸šåŠ¡æ¸…æ™°** - ä»£ç ç»„ç»‡ç›´æ¥åæ˜ ä¸šåŠ¡ç»“æ„

#### ä¼ ç»Ÿåˆ†å±‚ vs DDD

**ä¼ ç»Ÿåˆ†å±‚ï¼ˆæ°´å¹³åˆ‡åˆ†ï¼‰ï¼š**

```
services/
â”œâ”€â”€ controllers/  # æ‰€æœ‰æ§åˆ¶å™¨
â”œâ”€â”€ services/     # æ‰€æœ‰æœåŠ¡
â”œâ”€â”€ repositories/ # æ‰€æœ‰ä»“å‚¨
â””â”€â”€ models/       # æ‰€æœ‰æ¨¡å‹
```

**DDDï¼ˆå‚ç›´åˆ‡åˆ†ï¼‰ï¼š**

```
services/
â”œâ”€â”€ model/        # æ¨¡å‹é¢†åŸŸçš„æ‰€æœ‰å†…å®¹
â”œâ”€â”€ capability/   # èƒ½åŠ›é¢†åŸŸçš„æ‰€æœ‰å†…å®¹
â””â”€â”€ provider/     # æä¾›å•†é¢†åŸŸçš„æ‰€æœ‰å†…å®¹
```

## ğŸ¯ ä¸šåŠ¡é¢†åŸŸåˆ’åˆ†

### 1. Model Domain (æ¨¡å‹é¢†åŸŸ) ğŸ”µ

**æ ¸å¿ƒèŒè´£ï¼š**

- æ¨¡å‹çš„å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
- æ¨¡å‹æŸ¥è¯¢å’Œåˆ—è¡¨å±•ç¤º
- æ¨¡å‹ç¼“å­˜ä¼˜åŒ–
- æ¨¡å‹ä¸æä¾›å•†çš„å…³è”

**æœåŠ¡åˆ—è¡¨ï¼š**

| æœåŠ¡ | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| `ModelService` | `model_service.py` | æ¨¡å‹çš„å¢åˆ æ”¹æŸ¥ã€çŠ¶æ€ç®¡ç† |
| `ModelQueryService` | `model_query_service.py` | æ¨¡å‹æŸ¥è¯¢ã€åˆ—è¡¨æ„å»ºã€æ€§èƒ½ä¼˜åŒ– |
| `ModelsCacheManager` | `cache_manager.py` | æ¨¡å‹åˆ—è¡¨ç¼“å­˜ã€å‘½ä¸­ç‡ç»Ÿè®¡ |
| `ModelProviderService` | `model_provider_service.py` | æ¨¡å‹ä¸æä¾›å•†çš„å…³è”ç®¡ç† |

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```python
from app.services.model import (
    ModelService,
    model_query_service,
    models_cache
)

# è·å–æ¨¡å‹åˆ—è¡¨ï¼ˆå¸¦ç¼“å­˜ï¼‰
models = model_query_service.get_models_with_capabilities()

# æ¸…ç†ç¼“å­˜
models_cache.clear_cache()
```

### 2. Capability Domain (èƒ½åŠ›é¢†åŸŸ) ğŸŸ¢

**æ ¸å¿ƒèŒè´£ï¼š**

- èƒ½åŠ›çš„å®šä¹‰å’Œç®¡ç†
- æ¨¡å‹èƒ½åŠ›çš„å…³è”
- èƒ½åŠ›çš„å¢åˆ æ”¹æŸ¥

**æœåŠ¡åˆ—è¡¨ï¼š**

| æœåŠ¡ | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| `CapabilityService` | `capability_service.py` | èƒ½åŠ›ç®¡ç†ã€æ¨¡å‹èƒ½åŠ›å…³è” |

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```python
from app.services.capability import capability_service

# è·å–æ‰€æœ‰èƒ½åŠ›
capabilities = capability_service.get_all_capabilities()

# ä¸ºæ¨¡å‹æ·»åŠ èƒ½åŠ›
capability_service.add_model_capability("gpt-4", "vision")
```

### 3. Provider Domain (æä¾›å•†é¢†åŸŸ) ğŸŸ 

**æ ¸å¿ƒèŒè´£ï¼š**

- æä¾›å•†çš„ç®¡ç†
- API Key ç®¡ç†
- æä¾›å•†é…ç½®

**æœåŠ¡åˆ—è¡¨ï¼š**

| æœåŠ¡ | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| `ProviderService` | `provider_service.py` | æä¾›å•†ç®¡ç†ã€API Key ç®¡ç† |

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```python
from app.services.provider import ProviderService

provider_service = ProviderService(db_service)

# è·å–æ‰€æœ‰æä¾›å•†
providers = provider_service.get_all_providers(is_enabled=True)
```

## ğŸ› ï¸ æ”¯æ’‘æœåŠ¡

### Database Services (æ•°æ®åº“æœåŠ¡) ğŸ”´

- æ•°æ®æŒä¹…åŒ–
- äº‹åŠ¡ç®¡ç†
- ORM å°è£…

### Adapters (é€‚é…å™¨æœåŠ¡) ğŸŸ¤

- LLM æä¾›å•†é€‚é…å™¨ç®¡ç†
- è¿æ¥æ± ç®¡ç†
- å¥åº·æ£€æŸ¥

### Load Balancing (è´Ÿè½½å‡è¡¡) ğŸŸ¡

- æ™ºèƒ½è·¯ç”±
- è´Ÿè½½å‡è¡¡ç­–ç•¥
- æµé‡åˆ†å‘

### Monitoring (ç›‘æ§æœåŠ¡) ğŸŸ£

- å¥åº·æ£€æŸ¥
- æ€§èƒ½ç›‘æ§
- å¯ç”¨æ€§æ£€æµ‹

### Infrastructure (åŸºç¡€è®¾æ–½) âš™ï¸

- æœåŠ¡å·¥å‚
- ä¾èµ–æ³¨å…¥
- æœåŠ¡åè°ƒ

## ğŸ“¦ ä½¿ç”¨æ–¹å¼

### æ–¹å¼ 1ï¼šç»Ÿä¸€å…¥å£å¯¼å…¥ï¼ˆæ¨èï¼‰

```python
from app.services import (
    # Model Domain
    ModelService,
    model_query_service,
    models_cache,
    
    # Capability Domain
    capability_service,
    
    # Provider Domain
    ProviderService,
    
    # Infrastructure
    ServiceManager,
    
    # Database
    db_service,
    
    # Adapters
    adapter_manager,
)
```

### æ–¹å¼ 2ï¼šç›´æ¥ä»é¢†åŸŸå¯¼å…¥

```python
# ä»æ¨¡å‹é¢†åŸŸå¯¼å…¥
from app.services.model import ModelService, models_cache

# ä»èƒ½åŠ›é¢†åŸŸå¯¼å…¥
from app.services.capability import capability_service

# ä»æä¾›å•†é¢†åŸŸå¯¼å…¥
from app.services.provider import ProviderService
```

## ğŸ¨ è®¾è®¡åŸåˆ™

1. **é¢†åŸŸé©±åŠ¨** - æŒ‰ä¸šåŠ¡é¢†åŸŸç»„ç»‡ï¼Œè€ŒéæŠ€æœ¯å±‚æ¬¡
2. **å•ä¸€èŒè´£** - æ¯ä¸ªæœåŠ¡ç±»åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½é¢†åŸŸ
3. **é«˜å†…èšä½è€¦åˆ** - é¢†åŸŸå†…é«˜å†…èšï¼Œé¢†åŸŸé—´ä½è€¦åˆ
4. **ä¾èµ–å€’ç½®** - ä¾èµ–äºæŠ½è±¡ï¼Œè€Œéå…·ä½“å®ç°
5. **å¼€é—­åŸåˆ™** - å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­

## ğŸ“Š æ¶æ„å¯¹æ¯”

| ç»´åº¦ | ä¼ ç»Ÿåˆ†å±‚æ¶æ„ | DDD é¢†åŸŸæ¶æ„ |
|------|------------|-------------|
| **ç»„ç»‡æ–¹å¼** | æŒ‰æŠ€æœ¯å±‚æ¬¡ï¼ˆæ°´å¹³ï¼‰ | æŒ‰ä¸šåŠ¡é¢†åŸŸï¼ˆå‚ç›´ï¼‰ |
| **æ–‡ä»¶æŸ¥æ‰¾** | éœ€è¦è·¨å¤šä¸ªç›®å½• | åœ¨ä¸€ä¸ªé¢†åŸŸç›®å½•å†… |
| **ä¸šåŠ¡ç†è§£** | éœ€è¦ç»„åˆå¤šä¸ªå±‚æ¬¡ | ç›´æ¥åæ˜ ä¸šåŠ¡ç»“æ„ |
| **å›¢é˜Ÿåä½œ** | å®¹æ˜“å†²çª | é¢†åŸŸç‹¬ç«‹å¼€å‘ |
| **æ‰©å±•æ€§** | ä¿®æ”¹å½±å“å¤šå±‚ | é¢†åŸŸå†…éƒ¨ä¿®æ”¹ |
| **ç»´æŠ¤æ€§** | ä¸­ç­‰ | é«˜ |

## ğŸ”„ ä¾èµ–å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         API Layer (è·¯ç”±å±‚)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚           â”‚           â”‚
â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
â”‚  Model   â”‚ â”‚Capabilityâ”‚ â”‚ Provider â”‚
â”‚  Domain  â”‚ â”‚ Domain  â”‚ â”‚  Domain  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
      â”‚          â”‚           â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                      â”‚
â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Database   â”‚    â”‚ Supporting Servicesâ”‚
â”‚ Services   â”‚    â”‚ Adapters, Monitor â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âœ… ä¼˜åŠ¿æ€»ç»“

1. **ä¸šåŠ¡æ¸…æ™°** - ä»£ç ç»„ç»‡ç›´æ¥åæ˜ ä¸šåŠ¡ç»“æ„
2. **æ˜“äºç»´æŠ¤** - ç›¸å…³ä»£ç èšåˆåœ¨ä¸€èµ·
3. **å›¢é˜Ÿåä½œ** - ä¸åŒå›¢é˜Ÿè´Ÿè´£ä¸åŒé¢†åŸŸ
4. **æ‰©å±•å‹å¥½** - æ–°å¢é¢†åŸŸæˆ–åŠŸèƒ½å®¹æ˜“æ‰©å±•
5. **é™ä½è€¦åˆ** - é¢†åŸŸä¹‹é—´é€šè¿‡æ¥å£é€šä¿¡
6. **ä¾¿äºæµ‹è¯•** - é¢†åŸŸç‹¬ç«‹ï¼Œä¾¿äºå•å…ƒæµ‹è¯•

## ğŸ“š å‚è€ƒèµ„æ–™

- [Domain-Driven Design (DDD)](https://martinfowler.com/bliki/DomainDrivenDesign.html)
- [Vertical Slice Architecture](https://jimmybogard.com/vertical-slice-architecture/)
- [Clean Architecture](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)

---

**æœ€åæ›´æ–°æ—¶é—´ï¼š** 2025-10-06  
**æ¶æ„ç‰ˆæœ¬ï¼š** v2.0 - DDD é¢†åŸŸé©±åŠ¨è®¾è®¡
